<?php 

class measureList extends _entityList{
	protected $__MyClassName = 'MeasureList';



	public $sql;
	
	public function __construct($mode = 'VIEW', $id = 0, $idParent = 0){
		parent::__construct($mode, $id, $idParent);
		$this->task = new Task($this->pageMode, $this->idParent);
		$this->sql = new MeasureSQL;
	}
	
	public function setDetails(){
		$this->task->setDetails();
		$this->setFoundCount();
	}
		
	protected function setPageTitle(){

		$title = $this->task->project->name.br();
		$title .= 'Task: '.$this->task->name;

		$this->_pageTitle = $title;	
	}	

	protected function pageMenu(){
		$menuType = 'LIST';
		$menuStyle = 'menu';
		
		$projects = new ProjectLinks($menuType,$menuStyle);
		$tasks = new TaskLinks($menuType,$menuStyle);
		$measures = new MeasureLinks($menuType,$menuStyle);
					
		$menu = $projects->openMenu('section-heading-links');
		

		$menu .= $tasks->detailViewHref($this->task->id);
		$menu .= $projects->detailViewHref($this->task->project->id);
		
		$menu .= $projects->resetMenu();
		
		$menu .= $measures->detailAddHref($this->task->id);
		$menu .= $measures->listingHref($this->task->id);		
		
		$menu .= $projects->closeMenu();	
		$this->_pageMenu = $menu;			
	}	
	
	public function setFoundCount(){
		$sql = $this->sql->countTask($this->task->id);
		$this->found = dbGetCount($sql, 'total_measures');
	}
		
	public function getListing($pagingBaseLink = 'USE_LISTING'){
		$sql = $this->sql->listTask($this->task->id,$this->resultPage,$this->perPage);

		
		$ml = new MeasureLinks;		
		if ($pagingBaseLink == 'USE_LISTING'){
			$base = $ml->listing($this->task->id);
		} else { 
			$base = $pagingBaseLink;
		}
		$pagingLinks = $ml->listingPaged($base,$this->found,$this->resultPage,$this->perPage);		
		$m = new Measure('ADD', 0, $this->task->id);
		$m->setDetails();
		$quickEdit = $m->editForm();
		$list = openDisplayList('measure','Measures',$pagingLinks,$quickEdit);

		$heading =  wrapTh('Measure Type');
		$heading .=  wrapTh('Value');
		$heading .=  wrapTh('Name');
		$heading .=  wrapTh('Description');
		$heading .=  wrapTh('Date Reported');

		$list .=  wrapTr($heading);


		$result = dbGetResult($sql);
		if($result){
	  	while ($row = $result->fetch_assoc())
		{	
			$m = new Measure(FETCH);
			$m->id = $row["id"];
			$m->name = ($row["name"]);
			$m->measureType = ($row["measure_type"]);
			$m->unitSymbol = ($row["unit_symbol"]);
			$m->unitType = ($row["unit_type"]);
			$m->value = $row["value"];
			$m->dateReported = $row["date_reported"];
			$m->description = ($row["description"]);
			$m->formatForDisplay();
			
			$link = $ml->detailViewEditHref($m->id,$m->getMeasureTypeAndUnitSymbol());
			$detail =  wrapTd($link);			
			$detail .=  wrapTd($m->value);
			$detail .= wrapTd($m->name);
			$detail .=  wrapTd($m->description);
			$detail .=  wrapTd($m->dateReported);
			
			$list .=  wrapTr($detail);
		}
		$result->close();
		}
		
		$list .= closeDisplayList();
		return $list;
	}
}
?>
