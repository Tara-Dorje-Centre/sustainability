<?php

class UserSQL implements IentitySQL{
private function cols(){
	$c = " u.id, "; 
	$c .= " u.name_first, "; 
	$c .= " u.name_last, "; 
	$c .= " u.email, "; 
	$c .= " u.focus, ";
	$c .= " u.interests, "; 
	$c .= " u.login_name, ";
	$c .= " u.last_login, "; 
	$c .= " u.created, "; 
	$c .= " u.updated, ";
	$c .= " u.is_admin, ";
	$c .= " u.is_active, ";
	$c .= " u.must_update_pwd, ";
	$c .= " u.type_id, "; 
	$c .= " ut.name type_name, ";
	$c .= " ut.highlight_style ";
	return $c;	
}

protected function tables(){

	$t = " FROM users u LEFT OUTER JOIN user_types ut ON u.type_id = ut.id ";
	return $t;
}

public function info($id){
	$q = " SELECT ";	
	$q .= $this->cols();
	$q .= $this->tables();
	

	$q .= " WHERE  ";
	$q .= " u.id = ".$id." ";
	return $q;
}
public function list($page = 1,$perPage = 10){
	$q = " SELECT ";	
	$q .= $this->cols();
	
		$q .= $this->tables();

	/*if ($userTypeId > 0){
		$q .= " WHERE u.type_id = ".$userTypeId." ";
	}
	*/
	$q .= " ORDER BY login_name, name_first, name_last ";
	$q .= sqlLimitClause($page, $perPage);
	return $q;	
}
public function listByType($userTypeId,$resultPage, $rowsPerPage){
	$q = " SELECT ";	
	$q .= $this->cols();
	$q .= $this->tables();
	if ($userTypeId > 0){
		$q .= " WHERE u.type_id = ".$userTypeId." ";
	}
	$q .= " ORDER BY login_name, name_first, name_last ";
	$q .= sqlLimitClause($resultPage, $rowsPerPage);
	return $q;	
}
public function count(){
	$q = " SELECT ";	
	$q .= " COUNT(*) total_users ";
	$q .= $this->tables();
	//if ($userTypeId > 0){
	//	$q .= " WHERE u.type_id = ".$userTypeId." ";
	//}
	return $q;	
}

public function countType($typeId = 0){
	$q = " SELECT ";	
	$q .= " COUNT(*) total_users ";
	$q .= $this->tables();
	if ($userTypeId > 0){
		$q .= " WHERE u.type_id = ".$typeId." ";
	}
	return $q;	
}

public function validateUser($loginName, $loginPwdCrypt){
	$q = " SELECT count(*) AS user_count FROM users u ";
	$q .= " WHERE u.login_name = '".$loginName."' ";
	$q .= " AND u.login_pwd = '".$loginPwdCrypt."' ";
	$q .= " AND u.is_active = 'yes' ";	
	return $q;
}
public function validateLoginAndEmail($loginName, $loginEmail){
	$q = " SELECT count(*) AS user_count FROM users u ";
	$q .= " WHERE u.login_name = '".$loginName."' ";
	$q .= " AND u.email = '".$loginEmail."' ";
	$q .= " AND u.is_active = 'yes' ";	
	return $q;
}

public function securityUser($loginName){
	$q = " SELECT ";
	$q .= " u.id, u.is_admin, u.is_active, u.must_update_pwd ";
	$q .= " FROM users u ";
	$q .= " WHERE u.login_name = '".$loginName."' ";	
	return $q;
}

		public function updatePass($loginName, $newPassCrypt){
			$sql = "UPDATE users u SET ";
			$sql .= " u.login_pwd = '".$newPassCrypt."', ";
			$sql .= " u.must_update_pwd = 'yes' ";
			$sql .= " WHERE u.login_name = '".$loginName."' ";
			return $sql;
		}
		

	public function updateLastLogin($loginName){
		$sql = " UPDATE users u ";
		$sql .= " SET u.last_login = CURRENT_TIMESTAMP ";
		$sql .= " WHERE u.login_name = '".$loginName."' ";	
		return $sql;
		
	}
	
	public function options($selectedId = 0, $disabled = 'false'){
	
	
	
	}
		
}
?>
