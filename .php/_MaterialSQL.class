<?php 

class MaterialSQL{
function columnsMaterials(){
$c = " m.id, ";
$c .= " m.task_id, ";
$c .= " t.task_order, ";
$c .= " t.name task_name, ";
$c .= " m.location_id, ";
$c .= " m.name, ";
$c .= " m.description, ";
$c .= " m.date_reported, ";
$c .= " m.done_by, ";
$c .= " m.paid_to, ";
$c .= " m.updated, ";
$c .= " m.quantity, ";
$c .= " m.qty_unit_measure_id, ";
$c .= " uom.name qty_unit_measure_name, ";
$c .= " m.cost_unit, ";
$c .= " m.cost_estimated, ";
$c .= " m.cost_actual, ";
$c .= " m.type_id, ";
$c .= " mt.name type_name, ";
$c .= " mt.highlight_style, ";
$c .= " m.link_text, ";
$c .= " m.link_url, ";
$c .= " m.notes ";
return $c;	
}
public function infoMaterial($materialId){
$q = " SELECT ";	
$q .= $this->columnsMaterials();
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " LEFT OUTER JOIN material_types AS mt ON m.type_id = mt.id ";
$q .= " LEFT OUTER JOIN units_of_measure uom ON m.qty_unit_measure_id = uom.id ";
$q .= " WHERE  ";
$q .= " m.id = ".$materialId." ";
return $q;
}
public function listMaterialsByTask($selectedTaskId,$resultPage, $rowsPerPage,$year = 0,$month = 0){
$q = " SELECT ";	
$q .= $this->columnsMaterials();
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " LEFT OUTER JOIN material_types AS mt ON m.type_id = mt.id ";
$q .= " LEFT OUTER JOIN units_of_measure uom ON m.qty_unit_measure_id = uom.id ";
$q .= " WHERE  ";
$q .= " m.task_id = ".$selectedTaskId." ";
if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}
$q .= " ORDER BY ";
$q .= " date(m.date_reported) desc, m.name ";
$q .= sqlLimitClause($resultPage, $rowsPerPage);
return $q;
}
public function countMaterialsByTask($selectedTaskId,$year = 0,$month = 0){
$q = " SELECT  ";
$q .= " COUNT(*) total_materials";
$q .= " FROM materials AS m ";
$q .= " WHERE  ";
$q .= " m.task_id = ".$selectedTaskId." ";
if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}

return $q;
}
public function summarizeMaterialByTask($selectedTaskId,$year = 0,$month = 0){
$q = " SELECT  ";
$q .= " COUNT(*) total_materials, ";
$q .= " SUM(m.cost_estimated) sum_cost_estimated, ";
$q .= " SUM(m.cost_actual) sum_cost_actual ";
$q .= " FROM materials AS m ";
$q .= " WHERE  ";
$q .= " m.task_id = ".$selectedTaskId." ";
if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}

return $q;
}

public function listMaterialSummaryByProject($projectId, $year=0, $month=0){
$q = " SELECT  ";
$q .= " IFNULL(mt.name, 'Unspecified') material_type, ";
$q .= " COUNT(*) total_materials, ";
$q .= " SUM(m.cost_estimated) sum_cost_estimated, ";
$q .= " SUM(m.cost_actual) sum_cost_actual ";
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " LEFT OUTER JOIN material_types AS mt ON m.type_id = mt.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";

if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}
$q .= " AND t.materials_auth_project = 'yes' ";

$q .= " GROUP BY material_type ";

return $q;
}

public function listMaterialSummaryByTask($taskId,$projectId,$year=0, $month=0){
$q = " SELECT  ";
$q .= " IFNULL(mt.name, 'Unspecified') material_type, ";
$q .= " COUNT(*) total_materials, ";
$q .= " SUM(m.cost_estimated) sum_cost_estimated, ";
$q .= " SUM(m.cost_actual) sum_cost_actual ";
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " LEFT OUTER JOIN material_types AS mt ON m.type_id = mt.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";
$q .= " AND t.id = ".$taskId." ";
if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}

$q .= " GROUP BY material_type ";

return $q;
}

public function listMaterialSummaryByTaskDoneBy($taskId,$projectId,$year=0, $month=0){
$q = " SELECT  ";
$q .= " IF(m.done_by='', 'Unspecified', m.done_by) done_by, ";
$q .= " COUNT(*) total_materials, ";
$q .= " SUM(m.cost_estimated) sum_cost_estimated, ";
$q .= " SUM(m.cost_actual) sum_cost_actual ";
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " LEFT OUTER JOIN material_types AS mt ON m.type_id = mt.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";
$q .= " AND t.id = ".$taskId." ";
if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}

$q .= " GROUP BY done_by ";

return $q;
}
public function listMaterialSummaryByProjectDoneBy($projectId,$year=0, $month=0){
$q = " SELECT  ";
$q .= " IF(m.done_by='', 'Unspecified', m.done_by) done_by, ";
$q .= " COUNT(*) total_materials, ";
$q .= " SUM(m.cost_estimated) sum_cost_estimated, ";
$q .= " SUM(m.cost_actual) sum_cost_actual ";
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";
if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}
$q .= " AND t.materials_auth_project = 'yes' ";
$q .= " GROUP BY done_by ";

return $q;
}


public function listMaterialsByProject($projectId,$resultPage, $rowsPerPage,$year = 0,$month = 0){
$q = " SELECT ";	
$q .= $this->columnsMaterials();
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " LEFT OUTER JOIN material_types AS mt ON m.type_id = mt.id ";
$q .= " LEFT OUTER JOIN units_of_measure uom ON m.qty_unit_measure_id = uom.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";

if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}

$q .= " AND t.materials_auth_project = 'yes' ";
$q .= " ORDER BY ";
$q .= " date(m.date_reported) desc, t.task_order, m.name ";
$q .= sqlLimitClause($resultPage, $rowsPerPage);
return $q;
}
public function countMaterialsByProject($projectId, $year = 0,$month = 0){
$q = " SELECT  ";
$q .= " COUNT(*) total_materials";
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";

$q .= " AND t.materials_auth_project = 'yes'";

if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}

return $q;
}
public function summarizeMaterialByProject($projectId,$year = 0,$month = 0){
$q = " SELECT  ";
$q .= " COUNT(*) total_materials, ";
$q .= " SUM(m.cost_estimated) sum_cost_estimated, ";
$q .= " SUM(m.cost_actual) sum_cost_actual ";
$q .= " FROM materials AS m ";
$q .= " JOIN tasks AS t ON m.task_id = t.id ";
$q .= " WHERE  ";
$q .= " t.project_id = ".$projectId." ";
$q .= " AND t.materials_auth_project = 'yes'";

if ($year > 0){
	$q .= " AND year(m.date_reported)  = ".$year." ";	
}
if ($month > 0){
	$q .= " AND MONTH(m.date_reported)  = ".$month." ";	
}


return $q;
}

public function calendarLinksProjectMaterials($projectId){
  $q = "SELECT ";
  $q .= " MONTH(a.date_reported) month, ";
  $q .= " YEAR(a.date_reported) year ";
  $q .= " FROM projects p JOIN tasks t ON p.id = t.project_id  ";
  $q .= " JOIN materials a ON t.id = a.task_id  ";
  $q .= " WHERE p.id = ".$projectId." ";
  $q .= " AND t.materials_auth_project = 'yes'";
  $q .= " GROUP BY  ";
  $q .= " YEAR(a.date_reported), ";
  $q .= " MONTH(a.date_reported) ";
  return $q;
}
public function calendarLinksTaskMaterials($projectId,$taskId){
  $q = "SELECT ";
  $q .= " MONTH(m.date_reported) month, ";
  $q .= " YEAR(m.date_reported) year ";
  $q .= " FROM projects p JOIN tasks t ON p.id = t.project_id  ";
  $q .= " JOIN materials m ON t.id = m.task_id  ";
  $q .= " WHERE p.id = ".$projectId." ";
  $q .= " AND t.id = ".$taskId." ";
  $q .= " GROUP BY  ";
  $q .= " YEAR(m.date_reported), ";
  $q .= " MONTH(m.date_reported) ";
  return $q;
}


}
?>




