<?php 

class UserList extends __EntityList{

	public $userTypeId = 0;
	private $sql;
	
	public function __construct($mode = 'VIEW', $id = 0, $idParent = 0){
		parent::__construct($mode, $id, $idParent);
		$this->sql = new UserSQL;
	}
	
	public function setDetails(){
		
		//$this->userTypeId = $userTypeId;
		$this->setFoundCount();
	}
	
	protected function setPageTitle(){
		$this->_pageTitle .= 'User Profiles';
	}

	protected function setPageMenu(){
		$menuType = 'LIST';
		$menuStyle = 'menu';
		
		$userL = new UserLinks($menuType,$menuStyle);
		$menuL = new MenuLinks($menuType,$menuStyle);
		
		$menu = $userL->openMenu('section-heading-links');
		$menu .= $menuL->linkReference();
		$menu .= $userL->resetMenu();
		if ($_SESSION['is-admin'] == 'yes'){
			//only allow admins to add users
			$menu .= $userL->detailAddHref();
		}
		$menu .= $userL->listingHref();
		
		$menu .= $userL->closeMenu();
		$this->_pageMenu = $menu;			
	}
	
	public function setFoundCount(){
		$sql = $this->sql->countUsers($this->userTypeId);
		$this->found = dbGetCount($sql, 'total_users');
	}	
	
	public function getListing($pagingBaseLink = 'USE_LISTING'){
		
		$s = new UserSQL;
		$sql = $s->listUsers($this->userTypeId,$this->resultPage,$this->perPage);

		$cl = new UserLinks;
		if ($pagingBaseLink == 'USE_LISTING'){
			$base = $cl->listing($this->userTypeId);
		} else { 
			$base = $pagingBaseLink;
		}
		$pagingLinks = $cl->listingPaged($base, $this->found,$this->resultPage,$this->perPage);
		$u = new User('ADD');
		$quickEdit = $u->editForm();
		$list = openDisplayList('users','Users',$pagingLinks,$quickEdit);
		
		$heading = wrapTh('Login Name');
		$heading .= wrapTh('Profile Type');
		$heading .= wrapTh('First Name');
		$heading .= wrapTh('Last Name');
		$heading .= wrapTh('Focus');
		$heading .= wrapTh('Interests');
		$heading .= wrapTh('Last Login');
		
		$list .= wrapTr($heading);

		$result = dbGetResult($sql);
		if($result){
	  	while ($row = $result->fetch_assoc())
		{	
			$u = new User;
			$u->id = $row["id"];
			$u->nameFirst = ($row["name_first"]); 
			$u->nameLast = ($row["name_last"]); 
			$u->email = ($row["email"]); 
			$u->focus = ($row["focus"]);
			$u->interests = ($row["interests"]);
			$u->loginName = ($row["login_name"]);
			$u->lastLogin = $row["last_login"]; 
			$u->created = $row["created"]; 
			$u->typeId = $row["type_id"];
			$u->typeName = $row["type_name"];
			$u->cssHighlight = $row["highlight_style"];
			
			$u->formatForDisplay();
			
			if ($_SESSION['is-admin'] == 'yes' || $_SESSION['user-id'] == $u->id){
				$link = $cl->detailViewEditHref($u->id,$u->loginName);
			} else {
				$link = $cl->detailViewHref($u->id, $u->loginName);
			}
			$detail = wrapTd($link);
			$detail .= wrapTd($u->typeName);
			$detail .=  wrapTd($u->nameFirst);			
			$detail .=  wrapTd($u->nameLast);		
			$detail .=  wrapTd($u->focus);		
			$detail .=  wrapTd($u->interests);		
			$detail .=  wrapTd($u->lastLogin);		
			
			//css will be based on user type
			if ($u->cssHighlight <> '' && !is_null($u->cssHighlight)){
				$cssRow = $u->cssHighlight;
			} else {
				$cssRow = 'none';
			}
			$list .=  wrapTr($detail,$cssRow);
		}
		
		$result->close();
		}

		$list .= closeDisplayList();

		return $list;
		
	}
}
?>
