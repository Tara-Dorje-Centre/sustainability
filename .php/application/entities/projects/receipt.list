<?php
namespace application\entities\projects;

class receiptList extends \application\entityList{

	public $showSummary = 'NO';
	public $displayLevel = 'ACTIVITY';
	public $projectId = 0;
	public $taskId = 0;
	public $activityId = 0;

 	public function __construct(){
		parent::__construct();
		$this->entityTitle = 'Receipts';
		$this->base = new receipt();
	}
	
	public function getRequestArguments(){
		parent::getRequestArguments();

		//push identifiers to base object
		//sets quickEdit form default idParent
		$this->base->setIdentifiers($this->pageMode,$this->id,$this->idParent,$this->idType);
		
		$display = $this->_GET('display-level','ACTIVITY');
		$this->setDisplayLevel($display);

		$show = $this->_GET('show-summary','NO');
		$this->setShowSummary($show);

		$id = $this->_GET('project-id',0);
		$this->setProjectId($id);
		
		$id = $this->_GET('task-id',0);
		$this->setTaskId($id);

		$id = $this->_GET('activity-id',$this->idParent);
		
		$this->setActivityId($id);
		
		$this->setIdsByDisplayLevel();

	}
	
	public function getRequestPaging(){
	 	
	 	$var = 'receipt-results-page';
		$page = $this->_GET($var,1);
		
		$rows = $this->_GET('perPage',10);
		
		$this->setPaging($page,$rows);
	}
	
	public function setIdsByDisplayLevel(){
	
		if ($this->displayLevel == 'ACTIVITY'){
			$a = new activity();
			$this->taskId = $a->getTaskId($this->activityId);
			$this->projectId = $a->getProjectId($this->activityId);
		} elseif ($this->displayLevel == 'TASK'){
			$t = new task();
			$this->projectId = $t->getProjectId($this->taskId);
		} 
	}
	
	public function setDisplayLevel($display = 'ACTIVITY'){
		$this->displayLevel = $display;
		$this->base->setDisplayLevel($display);
	}
	
	public function setShowSummary($show = 'NO'){
		$this->showSummary = $show;
		$this->base->setShowSummary($show);
	}
	
	public function setProjectId($id = 0){
		$this->projectId = $id;
		$this->base->setProjectId($id);
	}
	
	public function setTaskId($id = 0){
		$this->taskId = $id;
		$this->base->setTaskId($id);
	}
	
	public function setActivityId($id = 0){
		$this->activityId = $id;
		$this->base->setActivityId($id);
	}
	
	protected function makePageTitle(){
		
		$br = new \html\_br();
		if ($this->displayLevel == 'ACTIVITY'){
			$a = new activity();
			$title = 'Project: '.$a->getProjectName($this->activityId).$br->print();
			$title .= 'Task: '.$a->getTaskName($this->activityId).$br->print();
			$title .= 'Activity: '.$a->getActivityName($this->activityId).$br->print();
			$title .= 'Activity Receipts';
		} elseif ($this->displayLevel == 'TASK'){
			$t = new task();
			$title = 'Project: '.$t->getProjectName($this->taskId).$br->print();
			$title .= 'Task: '.$t->getTaskName($this->taskId).$br->print();
			$title .= 'Task Receipts';
		} elseif ($this->displayLevel == 'PROJECT'){
			$p = new project();
			$title = 'Project: '.$p->getProjectName($this->projectId).$br->print();
			$title .= 'Project Receipts';
		}

		$this->_pageTitle = $title;
	}	

	protected function makePageMenu(){
		$menu = '';
		$p = new links\projectLinks();
		$t = new links\taskLinks();
		$a = new links\activityLinks();
		if ($this->displayLevel == 'ACTIVITY'){
			$this->base->links->addLink($p->view('View Project',$this->projectId));
			$this->base->links->addLink($t->view('View Task',$this->taskId));
			$this->base->links->addLink($a->view('View Activity',$this->activityId));
			$this->base->links->addLink($this->base->links->add('New Receipt',$this->activityId));
		} elseif ($this->displayLevel == 'TASK'){
			$this->base->links->addLink($p->view('View Project',$this->projectId));
			$this->base->links->addLink($t->view('View Task',$this->taskId));
		} elseif ($this->displayLevel == 'PROJECT'){
			$this->base->links->addLink($p->view('View Project',$this->projectId));
		}
		$menu = $this->base->links->print();
		$this->_pageMenu = $menu;				
	}	
	
	
	public function setFoundCount(){
		$this->echoState(true, 'setFoundCount');
		$this->echoValue(true, 'displayLevel',$this->displayLevel, 'setFoundCount');
		if ($this->displayLevel == 'ACTIVITY'){
			$sql = $this->base->sql->countActivity($this->activityId);
		} elseif ($this->displayLevel == 'TASK'){
			$sql = $this->base->sql->countTask($this->taskId);
		} elseif ($this->displayLevel == 'PROJECT'){
			$sql = $this->base->sql->countProject($this->projectId);
		}
		$this->found = $this->base->sql->getCount($sql,'count_details');
		
	}
	
	
	
	
	protected function listingSQL(){
	
		if ($this->displayLevel == 'ACTIVITY'){
			$sql = $this->base->sql->listActivity($this->activityId,$this->resultPage,$this->perPage);
		} elseif ($this->displayLevel == 'TASK'){
			$sql = $this->base->sql->listTask($this->taskId,$this->resultPage,$this->perPage);
		} elseif ($this->displayLevel == 'PROJECT'){
			$sql = $this->base->sql->listProject($this->projectId,$this->resultPage,$this->perPage);
		}
	
		return $sql;
	}
	
	
	private function getSummary(){
		$summary = new \html\_div('summary');
		$details = new \html\_fieldset('summary',$this->displayLevel.' Receipt Totals','summary-fieldset');
		
		if ($this->displayLevel == 'ACTIVITY'){
			$sql = $this->base->sql->summaryActivity($this->activityId);
		} elseif ($this->displayLevel == 'TASK'){
			$sql = $this->base->sql->summaryTask($this->taskId);
		} elseif ($this->displayLevel == 'PROJECT'){
			$sql = $this->base->sql->summaryProject($this->projectId);
		}
		$items = $this->base->sql->getScalar($sql,'total_items');
		//$est = $this->base->sql->getScalar($sql, 'sum_estimated');
		$actual = $this->base->sql->getScalar($sql, 'sum_actual');
		$d = new \html\_div();
		$d->addContent($items.' entries.  ');
		//$d->addContent('  Estimated cost = '.$est.'.');
		$d->addContent('  Total receipts = '.$actual.'.');
		$details->addContent($d->print());
		
		$summary->addContent($details->print());
		return $summary->print();
	}
	//override listing start 
	//to add args to paged listing
	protected function listingStart(\application\links\url $altUrl = NULL){
		
		$paging = $this->base->links->pagedListing($altUrl, $this->found,$this->resultPage,$this->perPage, $this->activityId,$this->taskId,$this->projectId,$this->showSummary,$this->displayLevel);	
		$add = '';
		if ($this->showSummary == 'NO' AND $this->displayLevel == 'ACTIVITY'){
			$add .= $this->base->addForm($this->activityId);	
		}
		$add .= $this->getSummary();
		$entity = $this->base->entity;
		$legend = $this->entityTitle.':  Listing';
		$this->_display = new \html\displayList($entity,$paging,$legend,$add,'none');

	}
	
	
	
	
}
?>
