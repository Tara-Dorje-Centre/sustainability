<?php
namespace application\entities\projects;

class taskList extends \application\entityList{

	public $periodicTasks = 'NO';
	public $taskStatus = 'INCOMPLETE';
	public $statusComplete = false;
	public function __construct(){
		parent::__construct();
		$this->entityTitle = 'Tasks';
		$this->base = new task();

	}
	public function getRequestArguments(){
		parent::getRequestArguments();
		//push identifiers to base object
		//sets quickEdit form default idParent
		$this->base->setIdentifiers($this->pageMode,$this->id,$this->idParent,$this->idType);
		
		$p = 'NO';
		if (isset($_GET['periodic-tasks'])){
			$p = $_GET['periodic-tasks'];
		}
		$this->setPeriodic($p);
		$this->base->setPeriodic($p);
		
		$p = 'INCOMPLETE';
		if (isset($_GET['task-status'])){
			$p = $_GET['task-status'];
		}
		$this->setStatus($p);
		//$this->base->setStatus($p);
		
	}
	
	
	public function setPeriodic($periodic = 'NO'){
		$this->periodicTasks = $periodic;
	}
	
	public function setStatus($status = 'INCOMPLETE'){
		$this->taskStatus = $status;
		if ($status == 'COMPLETE'){
			$this->statusComplete = true;
		} else {
			$this->statusComplete = false;
		}
	}
	protected function makePageTitle(){
		$title = 'Periodic Tasks: ';
		if ($this->periodicTasks == 'NO'){
			$p = new project();
			$name = $p->getProjectName($this->idParent);
			$title = 'Project: '.$name.'<br />';
			$title .= 'All Tasks';
		} else {
		
			$title .= $this->taskStatus;
		}
		$this->_pageTitle = $title;
	}
	
	
	protected function makePageMenu(){
		$s = new \application\links\systemMenuLinks();
		$this->base->links->addLink($s->modules());
		$this->base->links->addLink($s->reference());
		
		
		$p = new links\projectLinks();
		
		if ($this->periodicTasks == 'NO'){
			$this->base->links->addLink($p->view('View Project',$this->idParent));
			$this->base->links->addLink($this->base->links->list('List Tasks',0,$this->idParent,0));
			$this->base->links->addLink($this->base->links->add('New Task',$this->idParent));

		} else {
			$this->base->links->addLink($this->base->links->periodicTasks(!$this->statusComplete));
			$this->base->links->addLink($p->contextList('Active Projects'));
		}
		$this->_pageMenu = $this->base->links->print();
	}

	
	private function getPeriodicTasksComplete(){
		$complete = 'NO';
		if ($this->statusComplete == true){
			$complete = 'YES';
		}
		return $complete;		
	}
	
	public function setFoundCount(){
		if ($this->periodicTasks == 'NO'){
			$sql = $this->base->sql->countProject($this->idParent);
		} else {
			$sql = $this->base->sql->countPeriodic($this->getPeriodicTasksComplete());
		}
		
		$this->found = $this->base->sql->getCount($sql,'count_details');
		
	}
	
	protected function listingPagingLinks($pagingBaseLink = 'USE_LISTING'){
	
		if ($pagingBaseLink == 'USE_LISTING'){
			$base = $this->base->links->listing($this->idParent,$this->periodicTasks);
		} else { 
			$base = $pagingBaseLink;
		 }
		$pagingLinks = $this->base->links->listingPaged($base,$this->found,$this->resultPage,$this->perPage);		
		return $pagingLinks;
	
	}
	
	protected function listingQuickEdit(){
		$quickEdit =$this->base->addForm($this->idParent);		
		return $quickEdit;
	}
	
	public function listingSQL(){
	
		if ($this->periodicTasks == 'NO'){
			$sql = $this->base->sql->listProject($this->idParent,$this->resultPage,$this->perPage);
		} else {
			$sql = $this->base->sql->listPeriodic($this->getPeriodicTasksComplete(),$this->resultPage,$this->perPage);	
		}
		
		return $sql;
		}
		
}
?>
