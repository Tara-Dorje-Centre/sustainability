<?php

class _menu extends _echo{
	public $displayMode;
	public $year;
	public $month;
	protected $_MyClassName = '_menu';
	
	public function __construct(){
		$this->displayMode = new _textField('not_used','displayMode','mode');
		$this->year = new _numberField('not_used','year','mode');;
		$this->month = new _numberField('not_used','month','mode');
	}
	public function readRequest(){
		$this->displayMode->setEnvironment('GET');
		$this->year->setEnvironment('GET');
		$this->month->setEnvironment('GET');
		$this->displayMode->setDefault('MY_LINKS');
		$this->year->setDefault(0);
		$this->month->setDefault(0);
		$this->displayMode->read();
		$this->year->read();
		$this->month->read();
	}
	public function setDetails($displayMode = 'REFERENCE', $year = 0, $month = 0){
		$this->displayMode->set($displayMode);
		$this->year->set($year);
		$this->month->set($month);

	}
	
	public function PageTitle(){
		$t = new \html\_div('section-heading-title');
		switch($this->displayMode->value()){
			case 'REFERENCE':
			$title = 'Reference';		
			break;	
		case 'CALENDAR':
			$title = 'Calendar';
			break;
		case 'SYSTEM-UPDATES':
			$title = 'System Updates';
			break;
		case 'TESTING':
			$title = 'Testing';
			break;
		case 'MY_LINKS':
			$title = 'My Links';
			break;
		default:
			$title = 'Sustainable Planning Tools';						
		}
		
		$t->setContent($title);
	
		return $t->print();	
	}

	public function PageMenu(){
		$menuType = 'LIST';
		$menuStyle = 'menu';

		$l = new MenuLinks($menuType,$menuStyle);
		
		$menu = $l->openMenu('section-heading-links');
		
		$menu .= $l->linkMain();
		$menu .= $l->resetMenu();
//		$menu .= $l->linkMyLinks();
//		$menu .= $l->resetMenu();		
		$menu .= $l->linkReference();
		
		if ($_SESSION['is-admin'] == 'yes'){
			//only show testing to admins
		
		$menu .= $l->resetMenu();		
		$menu .= $l->detailHref('SYSTEM-UPDATES', 'System Updates');
		$menu .= $l->resetMenu();				
		$menu .= $l->detailHref('TESTING', 'Testing');
		}
		
		$menu .= $l->closeMenu();
		
		return $menu;			
	}
	
	public function getPageHeading(){
		$heading = $this->pageTitle();
		$heading .= $this->pageMenu();
		return $heading;
	}	
	
	
	private function displayReference(){
	$this->echoPrint(true,'start','displayReference');
		$menuType = 'LIST';
		$menuStyle = 'menu';
		$menuL = new menuLinks($menuType,$menuStyle);

		$locationTypeL = new locationTypeLinks($menuType,$menuStyle);

		$locationL = new locationLinks($menuType,$menuStyle);
		$unitL = new quantityTypeLinks($menuType,$menuStyle);
		$measureTypeL = new measureTypeLinks($menuType,$menuStyle);
		$cropL = new CropLinks($menuType,$menuStyle);
		$projectTypeL = new projectTypeLinks($menuType,$menuStyle);
		$taskTypeL = new taskTypeLinks($menuType,$menuStyle);
		$activityTypeL = new activityTypeLinks($menuType,$menuStyle);
		$materialTypeL = new materialTypeLinks($menuType,$menuStyle);
		$receiptTypeL = new receiptTypeLinks($menuType,$menuStyle);
		
		$userL = new userLinks($menuType, $menuStyle);
		$userTypeL = new userTypeLinks($menuType, $menuStyle);
		$sitewideSettingsL = new siteSettingsLinks($menuType, $menuStyle);
				
		$menu = $menuL->openMenu('section-content-links');

		$menu .= $locationL->listingHref();
		$menu .= $locationTypeL->listingHref();
		$menu .= $menuL->resetMenu();
		$menu .= $projectTypeL->listingHref();
		$menu .= $taskTypeL->listingHref();
		$menu .= $activityTypeL->listingHref();
		$menu .= $menuL->resetMenu();		
		$menu .= $materialTypeL->listingHref();
		$menu .= $receiptTypeL->listingHref();
		
		$menu .= $menuL->resetMenu();
		$menu .= $unitL->listingHref();
		$menu .= $measureTypeL->listingHref();
		$menu .= $menuL->resetMenu();
		$menu .= $cropL->listingHref();
		if ($_SESSION['is-admin'] == 'yes'){
			//only show userlist to admins
			$menu .= $menuL->resetMenu();
			$menu .= $userL->listingHref();
			$menu .= $userTypeL->listingHref();
			$menu .= $menuL->resetMenu();
			$menu .= $sitewideSettingsL->detailViewHref();
		}
		$menu .= $menuL->resetMenu();
		$menu .= $menuL->detailHref('CALENDAR', 'Calendars');
		
		$menu .= $menuL->closeMenu();
		return $menu;			
		
	}
		
	private function displayMyLinks(){
		$menuType = 'LIST';
		$menuStyle = 'menu';
		
		$projectL = new ProjectLinks($menuType,$menuStyle);
		$activityL = new ActivityLinks($menuType,$menuStyle);
		$taskL = new TaskLinks($menuType, $menuStyle);
		$userL = new UserLinks($menuType, $menuStyle);
				
		$menu = $projectL->openMenu('section-content-links');
		
		$menu .= $taskL->linksPeriodicTasks();
		$menu .= $projectL->resetMenu();		
		$menu .= $projectL->listingMyProjects();
		$menu .= $projectL->resetMenu();
		$menu .= $projectL->listingAllProjects();
		$menu .= $projectL->resetMenu();
//		$menu .= $taskL->formatTextItem('Calendars:');
		$menu .= $activityL->linkMyCalendar();
		$menu .= $projectL->resetMenu();
//		$menu .= $taskL->formatTextItem('History:');
		$menu .= $activityL->linkMyActivities();
		$menu .= $projectL->resetMenu();
		if (isset($_SESSION['logged-in']) && $_SESSION['logged-in'] == true){
			if ($_SESSION['must-update-pwd'] == 'yes'){
				$menu .= $userL->formatTextItem('Please update your profile password.');
			}
			$menu .= $userL->detailViewHref($_SESSION['user-id'], 'My Profile');
		}
		$menu .= $projectL->closeMenu();
		
		return $menu;
		
	}
	private function displayModules(){
		$menuType = 'LIST';
		$menuStyle = 'menu';
		$projectL = new ProjectLinks($menuType,$menuStyle);
		$taskL = new TaskLinks($menuType,$menuStyle);
		$activityL = new ActivityLinks($menuType,$menuStyle);
		$cropPlanL = new CropPlanLinks($menuType,$menuStyle);
		
		$menu = $projectL->openMenu('section-content-links');
		$menu .= $taskL->linksPeriodicTasks(true);
		$menu .= $projectL->resetMenu();
		$menu .= $projectL->listingAllProjects(true);		
		$menu .= $projectL->resetMenu();
//		$menu .= $taskL->formatTextItem('Calendars:');
		$menu .= $activityL->linkGroupCalendar();
		$menu .= $projectL->resetMenu();		
//		$menu .= $taskL->formatTextItem('History:');
		$menu .= $activityL->linkGroupActivities();
		$menu .= $projectL->resetMenu();
		//$menu .= $taskL->formatTextItem('Crop Planning:');
		$menu .= $cropPlanL->listingHref();

		$menu .= $projectL->closeMenu();
		return $menu;					
	}
	
	public function printPage(){
		
		$heading = $this->getPageHeading();
		$details = $this->getPageDetails();

		$site = new _htmlSite('MENU');
		$site->set($heading, $details);
		$site->print();
		
	}

	public function getPageDetails(){
	
		$details = $this->display();
		return $details;
		
	}
	
	
	protected function display(){
	$this->echoPrint(true,'start','display');
	$this->echoValue(true,'displayMode', $this->displayMode->value(), 'display');
	
		switch($this->displayMode->value()){
			case 'REFERENCE':
				$content = $this->displayReference();
				break;
			case 'CALENDAR':
				$content = $this->displayCalendar();
				break;
			case 'MY_LINKS':
				$content = $this->displayMyLinks();
				break;
			case 'SYSTEM-UPDATES':
				$content = $this->displaySystemUpdates();
				break;
			case 'TESTING':
				$content = $this->displayTesting();		
				break;				
			default:
				$content = $this->displayModules();
		}
		return $content;
		
	}

	private function displayCalendar(){
		if ($this->month->value() == 0 || $this->year->value() == 0){
			global $sessionTime;
			$this->year->set(\html\getTimestampYear($sessionTime));
			$this->month->set(\html\getTimestampMonth($sessionTime,'YES'));
		}
		if ($this->month->value() == 12){
			$nextMonth = 1;
			$nextYear = $this->year->value() + 1;
		} else {
			$nextMonth = $this->month->value() + 1;
			$nextYear = $this->year->value();
		}
		if ($this->month->value() == 1){
			$prevMonth = 12;
			$prevYear = $this->year->value() - 1;
		} else {
			$prevMonth = $this->month->value() - 1;
			$prevYear = $this->year->value();
		}

		$menuL = new MenuLinks('LIST','menu');
		$prevMonthLink = $menuL->detailHref('CALENDAR', 'Previous', $prevYear, $prevMonth);
		$nextMonthLink = $menuL->detailHref('CALENDAR', 'Next', $nextYear, $nextMonth);

		$c = new _calendar($this->year->value(),$this->month->value(),'Calendar');	
		$c->setLinks($nextMonthLink, $prevMonthLink);
		return $c->buildCalendar();
	}

	private function displayTesting(){
	
		include_once("sys_UnitTesting_Class.php");
		$tests = new _UnitTest;
		$tests->setDetails($this->displayMode->value,$this->year->value,$this->month->value);
		$content = $tests->display();
		
		return $content;
	
	}

	private function displaySystemUpdates(){
	
		include_once("sys_SystemUpdates.php");
		$update = new _SystemUpdate;
		$update->setDetails($this->displayMode->value,$this->year->value,$this->month->value);
		$content = $update->display();
		
		return $content;
	
		
	}

}
?>
