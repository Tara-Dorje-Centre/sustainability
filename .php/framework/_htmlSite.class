<?php 

interface IhtmlSite extends IhtmlPage{
	public function set(string $heading = 'page heading', string $details = 'page details');
}

class _htmlSite extends _htmlPage
implements IhtmlSite,IhtmlPage, Iecho{
	protected $settings;
	public $validLogin = false;
	protected $pageMode = 'VIEW';

	public function __construct($mode = 'VIEW'){
		$this->echoPrint(true,'begin','__construct','htmlSite');
		$this->pageMode = $mode;
		$this->settings = new siteSettings($mode);
		$this->verifyLoginState();
	}
	public function set(string $heading = 'page heading', string $details = 'page details'){
		$this->echoPrint(true,'begin','set','htmlSite');

		$this->getSiteSettings();
		$this->setOnLoad();
		$this->setStyles();
		$this->setScripts();
		$this->setTitle();
		$this->setLinks();
		$this->setContents($heading,$details);	
		$this->setFooterNotices();
		$this->setFooterLinks();	
	
		$this->echoPrint(true,'finished','set','htmlSite');
	}
	protected function verifyLoginState(){
		if (isset($_SESSION['logged-in']) && ($_SESSION['logged-in'] == true)){
			$this->validLogin = true;
		}
	}
	protected function getSiteSettings(){
		$this->echoPrint(true,'begin','getSiteSettings','htmlSite');
		$this->settings->setDetails();
	}
	
	protected function setOnLoad(){
		if ($this->validLogin == true){
			$onLoad = 'none';
		} else {
			$onLoad='displayClientTime();';
		}
		$this->setPageOnLoad($onLoad);
	}


	protected function setTitle(){
		if ($this->validLogin == true){
			$title = $this->settings->f->siteTitle->value();
		} else {
			$title = 'Login';
		}
		$this->setPageTitle($title);		
	}


	protected function setLinks(){

		//login check goes here to show content or login screen
		if ($this->validLogin == false){
			//user is not logged in, siteContent will display login form, display no links
			$this->setPageLinks('');
		} else {
			$menuType = 'LIST';
			$menuStyle = 'button';
			$m = new MenuLinks($menuType, $menuStyle);
			$p = new ProjectLinks($menuType, $menuStyle);
			$t = new TaskLinks($menuType, $menuStyle);
			$a = new ActivityLinks($menuType, $menuStyle);
		
			$content = $m->openMenu('site');
			if ($this->settings->f->showPublicSite->value == 'yes'){
				$content .= $m->formatHref('Library','public.php');	
			}
		
		if (isset($_SESSION['currentView'])){
			if ($_SESSION['currentView'] == 'PERIODIC_TASKS'){
				//user just viewed current open tasks;
				$content .= $t->linkPeriodicTasksOpen();
			} elseif ($_SESSION['currentView'] == 'MY_CALENDAR'){
				//user just viewed myCalendar;
				$content .= $a->linkMyCalendar();
			} elseif ($_SESSION['currentView'] == 'GROUP_CALENDAR'){
				//user just viewed groupCalendar;
				$content .= $a->linkGroupCalendar();
			} elseif ($_SESSION['currentView'] == 'MY_ACTIVITY'){
				//user just viewed myActivity;
				$content .= $a->linkMyActivities();
			} elseif ($_SESSION['currentView'] == 'GROUP_ACTIVITY'){
				//user just viewed groupActivity;
				$content .= $a->linkGroupActivities();
			}
		}

		//always show current open tasks;
		//$content .= $t->linkPeriodicTasksOpen();		
		//always show projects link
		$content .= $p->listingAllProjects(false);
		$content .= $m->detailHref();	
		$content .= $m->logoutHref();
		$content .= $m->closeMenu();
		
		$this->setPageLinks($content);
		
	}
	
}


	protected function setContents($heading,$details){ 

		if ($this->validLogin == false){
			$this->echoPrint(true,'not logged-in, setting contents to login form','setContents','htmlSite');
			$l = new UserLogin('LOGIN-FORM');
			$content = $l->loginForm();
		} else {
			$this->echoPrint(true,'logged-in,setting contents','setContents','htmlSite');
			//section-heading div commented out to allow section-links to float closer to section details
			//  pageHeading contains section-title and section-links div containers
			//  wrap title and links in section-heading div
			$h = new html/_div('section-heading');
			$h->setContent($heading);
			$d = new html/_div('section-details');
			$d->setContent($details);
		
			$content = $h->print();
			$content .= $d->print();
		}
	
		$this->setPageContents($content);
	}

	protected function setNoticeTiming(){
		global $sessionTime, $sessionTimeZone;
		$timing = 'Request Time: '.$sessionTime.'(UTC'.$sessionTimeZone.')';
		$t = new html/_div('display-request-time');
		$t->setContent($timing);
		
		if (isset($_SESSION['client-time-zone'])){
			$timeZone = '@UTC'.$_SESSION['client-time-zone'];	
		} else {
			$timeZone = ' Time Zone set to UTC';	
		}
		$t->addContent($timezone);
		return $t->print();
	}
	protected function setNoticeLoginName(){
		if (isset($_SESSION['login-name'])){
			$loginName = $_SESSION['login-name'];
		} else {
			$loginName = 'Not logged in.';	
		}
		$l = new html/_div('login-name');
		$l->setContent($loginName);
		return $l->print();
	}
	protected function setNoticeOrg(){
		$o .= new html/_div('site-organization');
		$org = $this->settings->f->organization->value();
		$orgUrl = $this->settings->f->organizationUrl->value();
		
		if (($orgUrl) == '' || is_null($orgUrl)){
			$content = $org;
		} else {
			$content = getHref($orgUrl, $org, 'menu-links-item', '_blank');
		}
		$o->setContent($content);
		return $o->print();
	}
	protected function setFooterNotices(){
		$n = new html/_div('login-notices');
		$n->addContent($this->setNoticeTiming());
		$n->addContent($this->setNoticeLoginName());
		$n->addContent($this->setNoticeOrg());
		$this->setPageFooterNotices($n->print());
	}

	protected function setFooterLinks(){
		$content = getHref('https://sourceforge.net/projects/sustainability','Sustainability','menu-links-item','_blank');
		$this->setPageFooterLinks($content);	
	}

	protected function setStyles(){
		//use internal stylesheet
		//$content = $this->buildInternalStyles();

		//use external stylesheet
		$content = LinkStylesheet('./css/styles.css');
		$content .= Linkstylesheet('./css/override.css');
		$this->setPageStyles($content);
		//return $content;
		
	}

	protected function setScripts(){
		$scripts = openScript();	
		//start oputput buffering
		ob_start();
		//include scripts to buffer
		include('./_siteJavascriptFunctions.inc');		
		//clear buffer to local variable
		$scripts .= ob_get_clean();  
		$scripts .= closeScript();
		$this->setPageScripts($scripts);
		//return $scripts;
	}
	
}

?>
