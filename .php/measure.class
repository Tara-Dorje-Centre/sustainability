<?php 




 class measureFields extends _entityFields{
	 public $dateReported;
	 public $value;	
	 public $measureTypeUnitId = 0;	
	 public $measureType;
	 public $unitType;
	 public $unitSymbol;
	 public $notes;

 public function __construct(){

 $this->hasProject = true;
 $this->hasTask = true;
 $this->hasActivity = false;
 $this->hasLocation = true;
 $this->hasUpdated = true;

 }


 public function setRow($row){
 parent::setRow();

	  $this->name = ($row["name"]);
	  $this->description = ($row["description"]);
	  $this->dateReported = $row["date_reported"];
	
	  $this->value = $row["value"];	
	  $this->measureTypeUnitId = $row["measure_type_unit_id"];						
	  $this->measureType = ($row["measure_type"]);
	  $this->unitSymbol = ($row["unit_symbol"]);
	  $this->unitType = ($row["unit_type"]);
	  $this->notes = ($row["notes"]);

 }

 public function defaults(){
 parent::defaults();

	 /*
	  global $sessionTime;
	  $this->dateReported = $sessionTime;	
	  $this->measureTypeUnitId = 0;
	  $this->locationId = $this->task->locationId;*/
 }

 public function format(){
 parent::format();

 $this->notes = formatText($this->notes);
 $this->dateReported = formatDate($this->dateReported);

 }

 public function display(){
 $this->addContent(parent::display(),true);
 $this->detailPara('Reported',$this->dateReported);
 
	 
	
	  $detail .= captionedParagraph('measure-value','Value',$this->value);
	/*  $m = new MeasureTypeUnit;
	  $select = $m->options($this->measureTypeUnitId,'measureTypeUnitId','true');*/
	  $detail .= captionedParagraph('measure-type-units','Measure Type', $select);
	  $detail .= captionedParagraph('unit-of-measure','Unit Type',$this->unitType);
 
 
 $this->detailPara('Notes',$this->notes);
 return $this->getContent();
 }

 public function listHeading(){
 $this->addContent(parent::listHeading(),true);
 $this->listTh('caption');
 return $this->getContent();
 }

 public function listDetail(){
 $this->addContent(parent::listDetail(),true);

 $this->listTd($this->field);
 return $this->getContent();
 }

 public function getPostVars(){
 		parent::getPostVars();
		$this->measureTypeUnitId = $this->postString('measureTypeUnitId'); 
		$this->value = $this->postString('value'); 
		$this->notes = $this->postString('notes'); 
		$this->dateReported = $this->postDate('dateReported');
 }

 }
 

class measure extends _entity {

protected $__MyClassName = 'Measure';
	protected $_titleEntity = 'Measurement';
  	protected $pageSave = 'pr_Measure_Save.php';


	public $task;	
	//public $sql;
	
    
	
	public function setHelperClasses(){
		$this->f = new MeasureFields();
		$this->links = new MeasureLinks();
		$this->sql = new MeasureSQL();
	}
		protected function beforeSetDetails(){
		}
		
	protected function afterSetDetails(){
	
		$this->setParentTask();			
		
	}	
	
	public function setParentTask(){
		$this->task->setDetails($this->pageMode, $this->task->id);
	}
		
	protected function setPageTitle(){	
		
		$title .= $this->task->project->name.br();
		$title .= 'Task: '.$this->task->name;		

		$this->_pageTitle = $title;
	}
	
	
	protected function setPageMenu(){
		$menuType = 'LIST';
		$menuStyle = 'menu';
		
		$projects = new ProjectLinks($menuType,$menuStyle);
		$tasks = new TaskLinks($menuType,$menuStyle);
		$measures = new MeasureLinks($menuType,$menuStyle);
					
		$menu = $projects->openMenu('section-heading-links');

		$menu .= $tasks->detailViewHref($this->task->id);
		$menu .= $projects->detailViewHref($this->task->project->id);			
		//$menu .= $measures->listingHref($this->task->id);
		$menu .= $projects->resetMenu();
		if ($this->pageMode == 'VIEW'){
			$menu .= $measures->detailEditHref($this->id);
		}
		if ($this->pageMode == 'EDIT'){
			$menu .= $measures->detailViewHref($this->id);
		}
		
		$menu .= $projects->closeMenu();
		$this->_pageMenu = $menu;
	}
		

	public function getMeasureTypeAndUnitSymbol(){
		$t = $this->measureType.'('.$this->unitSymbol.')';
		return $t;
	}
	protected function afterDisplay(){	
	
	}


	protected function afterSetDefaults(){	
	}
	
	public function editForm(){
		if ($this->pageMode == 'ADD'){		
			//$this->setDefaults();
			$legend = 'Add Measure';
		} else {
			$legend = 'Edit Measure';
		}
		$entity = 'measure';
		$c = new ProjectTypeLinks;
		$contextMenu = $c->formatToggleLink('formOptional','+Options');
		$form = openEditForm($entity,$legend,'pr_Measure_Save.php',$contextMenu);


		
		$fields = inputFieldNumber($entity,$this->value,'value','Value');

		$m = new MeasureTypeUnit;
		$select = $m->options($this->measureTypeUnitId,'measureTypeUnitId','false',false);
		$fields .= captionedInput('Measure Type',$select);

		$fields .= inputFieldTimestamp($entity, 'dateReported', $this->dateReported, 'Date Reported'); 		
		
		//end formRequired
		$formRequired = $fields;
		
		//formOptional
		$fields = inputFieldName($entity,$this->name,'name','Measure');

		$fields .= inputFieldDescription($entity,$this->description,'description');

		$fields .= inputFieldNotes($entity,$this->notes,'notes');

		$formOptional = $fields;

		//hidden fields and submit,reset buttons
		$hidden = getHiddenInput('mode', $this->pageMode);
		$hidden .= getHiddenInput('taskId', $this->task->id);
		$hidden .= getHiddenInput('locationId', $this->locationId);

		$hidden .= getHiddenInput('measureId', $this->id);
		$input = getSaveChangesResetButtons();
		$formSubmit = $hidden.$input;
	
		$form .= closeEditForm($entity,$formRequired,$formOptional,$formSubmit);		
		return $form;
	}
	
	public function afterCollectPostValues(){
		//called by save form prior to running adds/updates
		
		$this->setParentTask();
	}

	protected function saveUpdate(){
	

			
			$sql = " UPDATE measures m ";
			$sql .= " SET ";
			$sql .= " m.name = '".$this->name."', ";
			$sql .= " m.description = '".$this->description."', ";
			$sql .= " m.notes = '".$this->notes."', ";
			$sql .= " m.updated = CURRENT_TIMESTAMP, ";
			$sql .= " m.value = ".$this->value.", ";
			$sql .= " m.date_reported = '".$this->dateReported."', ";
			$sql .= " m.location_id = ".$this->locationId.", ";
			$sql .= " m.measure_type_unit_id = ".$this->measureTypeUnitId." ";
			$sql .= " WHERE m.id = ".$this->id." ";

			$result = dbRunSQL($sql);
			
	}
	
	protected function saveInsert(){
	
			$sql = " INSERT INTO measures ";
			$sql .= " (name, ";
			$sql .= " task_id, ";
			$sql .= " location_id, ";
			$sql .= " measure_type_unit_id, ";
			$sql .= " date_reported, ";
			$sql .= " value, ";
			$sql .= " description, ";
			$sql .= " notes) ";
			$sql .= " VALUES (";
			$sql .= "'".$this->name."', ";
			$sql .= " ".$this->task->id.", ";
			$sql .= " ".$this->locationId.", ";
			$sql .= "".$this->measureTypeUnitId.", ";
			$sql .= " '".$this->dateReported."', ";
			$sql .= "".$this->value.", ";
			$sql .= "'".$this->description."', ";
			$sql .= "'".$this->notes."') ";
			
			$result = dbRunSQL($sql);
			
			$this->id = dbInsertedId();
	
	}
	
} 
?>
