<?php 


class receiptFields extends _fieldsetTaskChild{

    public $dateReported;
	public $receivedBy;
	public $receivedFrom;
 
    public $quantity = 1;	
	public $quantityUnitMeasureId = 0;
	public $quantityUnitMeasureName = '';
    public $costUnit = 0;	
	public $costActual = 0;
    public $notes;
    
	public function __construct(){
	
		$this->hasType = true;
		$this->listType = true;
		$this->hasUpdated = true;
		$this->hasProject = true;
		$this->hasTask = true;
		$this->hasActivity = true;
	}
	
	public function setRow($row){
		parent::setRowV($row);

			$this->dateReported = $row["date_reported"];
			$this->receivedBy = ($row["received_by"]);
			$this->receivedFrom = ($row["received_from"]);
			
			$this->quantity = $row["quantity"];	
			$this->quantityUnitMeasureId = $row["qty_unit_measure_id"];
			$this->quantityUnitMeasureName = ($row["qty_unit_measure_name"]);
			$this->costActual = $row["cost_actual"];
			$this->costUnit = $row["cost_unit"];
			$this->notes = ($row["notes"]);
			
	}
	
	public function format(){
		parent::format();
		$this->notes = $this->formatText($this->notes);
		$this->dateReported = $this->formatDate($this->dateReported);
		
	}
	
	public function defaults(){
		parent::defaults();
		global $sessionTime;
		$this->dateReported = $sessionTime;	
		
		$this->quantity = 1;
		$this->quantityUnitMeasureId = 0;
		$this->costUnit = 0;
		$this->costActual = 0;		
		$this->receivedBy = $_SESSION['login-name'];
	}
	
	
	public function listHeading(){
	//$displayMode){
		$this->addContent(parent::listHeading(),true);
	
		return $this->getContent();
	}
	public function listDetail(){
	//$displayMode){
	
	}
	
	public function display(){
		$this->addContent(parent::display(),true);
		
		$this->detailPara('reported','Reported',$this->dateReported);
		$this->detailPara('receivedBy','Received By', $this->receivedBy);
		$this->detailPara('receivedFrom','Received From', $this->receivedFrom);
		$this->detailPara('updated','Updated',$this->updated);	
		$this->detailPara('quantity-units','Quantity Units',$this->quantityUnitMeasureName);	
		$this->detailPara('quantity','Quantity',$this->quantity);
		$this->detailPara('cost-unit','Unit Amount',$this->costUnit);
		$this->detailPara('cost-actual','Amount Actual',$this->costActual);
 		$this->detailPara('notes','Notes',$this->notes);
 		
 		return $this->getContent();

	}
	

	
	public function getPostVars(){
		parent::getPostVars();
	
		$this->notes = $this->$this->postString('notes'); 
		$this->dateReported = $this->postDate('dateReported');
		$this->receivedBy = $this->postString('receivedBy');
		$this->receivedFrom = $this->postString('receivedFrom');
		$this->quantity = $this->postVar('quantity', 0); 
		$this->quantityUnitMeasureId = $this->postVar('quantityUnitMeasureId',0);
		$this->costUnit = $this->postVar('costUnit',0); 
		
	}
}

class receipt extends _entity{
protected $__MyClassName = 'Receipt';

	protected $_titleEntity = 'Receipt';
	protected $pageSave = 'pr_Receipt_Save.php';

	protected function setHelperClasses(){
		$this->f = new receiptFields();
		$this->sql = new receiptSQL;
		$this->links = new receiptLinks();
	}
	
	protected function beforeSetDetails(){
	
	}
	protected function afterSetDetails(){

	}
	protected function afterSetDefaults(){

	}
	protected function afterDisplay(){

	}
	
	
	protected function setPageTitle(){	

		$title = $this->f->nameProject->name.br();
		$title .= 'Task: '.$this->f->nameTask;		

		$this->_pageTitle = $title;
		
	}
	
	
	protected function setPageMenu(){
		$menuType = 'LIST';
		$menuStyle = 'menu';
		
		$projects = new ProjectLinks($menuType,$menuStyle);
		$tasks = new TaskLinks($menuType,$menuStyle);
		$rL = new ReceiptLinks($menuType,$menuStyle);
					
		$menu = $projects->openMenu('section-heading-links');

		$menu .= $projects->detailViewHref($this->task->project->id);
		if ($this->task->project->receiptsCount > 0){
			$menu .= $rL->listingHref(0,'ProjectReceipts',$this->task->project->id,'PROJECT','YES');
		}
		
		$menu .= $projects->resetMenu();
		$menu .= $tasks->detailViewHref($this->task->id);
		if ($this->task->receiptCount > 0){
			$menu .= $rL->listingHref($this->task->id,'TaskReceipts',0,'TASK','NO');
		}
		$menu .= $projects->resetMenu();
		if ($this->pageMode == 'VIEW'){
			$menu .= $rL->detailEditHref($this->id);
		} elseif ($this->pageMode == 'EDIT'){
			$menu .= $rL->detailViewHref($this->id);
		}
		
		$menu .= $projects->closeMenu();
		$this->_pageMenu = $menu;
	}
	
	protected function editForm(){
			$legend = $this->pageMode.'Receipt';
		
		$entity = 'receipt';
		$c = new ProjectTypeLinks;
		$contextMenu = $c->formatToggleLink('formOptional','+Options');
		$form = openEditForm($entity,$legend,'pr_Receipt_Save.php',$contextMenu);

		//start required fields
		$fields = inputFieldName($entity,$this->f->name,'name','Receipt');

		$fields .= inputFieldUser($entity,$this->f->receivedBy,'receivedBy','Received By');

		$fields .= inputFieldUser($entity,$this->f->receivedFrom,'receivedFrom','Received From');
				
		$fields .= inputFieldNumber($entity,$this->f->costUnit,'costUnit','Unit Amount');

		$fields .= inputFieldTimestamp($entity, 'dateReported', $this->f->dateReported, 'Date Reported'); 		

		$fields .= inputFieldDescription($entity,$this->f-description,'description');

		//end required fields
		$formRequired = $fields;
		
		//start optional fields
		$fields = inputFieldNumber($entity,$this->f->quantity,'quantity','Quantity');
		
		$u = new UnitOfMeasure(OPTIONS);
		$select = $u->options($this->f->quantityUnitMeasureId,'quantityUnitMeasureId','false');
		$fields .= captionedInput('Quantity Units', $select);

		$tooltip = 'Set when task costs are approved';
		$fields .= inputFieldNumber($entity,$this->f->costActual,'costActual','Amount Actual',$tooltip);

		$m = new ReceiptType(OPTIONS);
		$select = $m->options($this->f->idType,'idType','false');
		$fields .= captionedInput('Receipt Type',$select);
		

		$fields .= inputFieldNotes($entity,$this->f-notes,'notes');

		//end optional fields (hidden by default)
		$formOptional = $fields;

		//hidden fields and submit,reset buttons
		$hidden = getHiddenInput('mode', $this->pageMode);
		$hidden .= getHiddenInput('idTask', $this->f->idTask);
		$hidden .= getHiddenInput('id', $this->f->id);
		$hidden .= getHiddenInput('idActivity', $this->f->idActivity);
		$input = getSaveChangesResetButtons();
		$formSubmit = $hidden.$input;
			
		$form .= closeEditForm($entity,$formRequired,$formOptional,$formSubmit);	

		return $form;
	}
	
	private function setActualCost(){
			$this->costActual = $this->f->costUnit * $this->f->quantity;
	}
	
	public function afterCollectPostValues(){
		//called by save form prior to running adds/updates
		//parent::collectPostValues();
		$this->setActualCost();

		$this->setParentTask();
	}

	protected function saveUpdate(){
	

			
			$sql = " UPDATE receipts m ";
			$sql .= " SET ";
			$sql .= " m.name = '".$this->f->name."', ";
			$sql .= " m.description = '".$this->f->description."', ";
			$sql .= " m.notes = '".$this->f->notes."', ";
			$sql .= " m.updated = CURRENT_TIMESTAMP, ";
			$sql .= " m.date_reported = '".$this->f->dateReported."', ";
			$sql .= " m.received_by = '".$this->f->receivedBy."', ";
			$sql .= " m.received_from = '".$this->f->receivedFrom."', ";			
			$sql .= " m.type_id = ".$this->f->idType.", ";
			$sql .= " m.activity_id = ".$this->f->idActivity.", ";
			$sql .= " m.quantity = ".$this->f->quantity.", ";
			$sql .= " m.qty_unit_measure_id = ".$this->f->quantityUnitMeasureId.", ";
			$sql .= " m.cost_unit = ".$this->f->costUnit.", ";
			$sql .= " m.cost_actual = ".$this->f->costActual." ";
			$sql .= " WHERE m.id = ".$this->f->id." ";

			$result = dbRunSQL($sql);
			
			$this->task->resetReceiptsAuthorization();
			
	}
			
	protected function saveInsert(){
	
			$sql = " INSERT INTO receipts ";
			$sql .= " (name, ";
			$sql .= " description, ";
			$sql .= " task_id, ";
			$sql .= " activity_id, ";
			$sql .= " date_reported, ";
			$sql .= " received_by, ";
			$sql .= " received_from, ";
			$sql .= " updated, ";
			$sql .= " quantity, ";
			$sql .= " cost_unit, ";
			$sql .= " cost_actual, ";
			$sql .= " type_id, ";
			$sql .= " qty_unit_measure_id, ";
			$sql .= " notes) ";
			$sql .= " VALUES (";
			$sql .= "'".$this->f->name."', ";
			$sql .= "'".$this->f->description."', ";
			$sql .= "".$this->f->idTask.", ";
			$sql .= "".$this->f->idActivity.", ";
			$sql .= " '".$this->f->dateReported."', ";
			$sql .= " '".$this->f->receivedBy."', ";
			$sql .= " '".$this->f->receivedFrom."', ";
			$sql .= " CURRENT_TIMESTAMP, ";
			$sql .= "".$this->f->quantity.", ";
			$sql .= "".$this->f->costUnit.", ";
			$sql .= "".$this->f->costActual.", ";
			$sql .= " ".$this->f->idType.", ";
			$sql .= " ".$this->f->quantityUnitMeasureId.", ";
			$sql .= "'".$this->f->notes."') ";
			
			$result = dbRunSQL($sql);

			$this->f->id = dbInsertedId();
			$this->id = $this->f->id;

			$this->task->resetReceiptsAuthorization();
	}
	
	
} 
?>
