<?php 

class ProjectSQL{
//projects table fields displayed in listing
	protected function columns(){
		$cols = " p.id, ";
		$cols .= " p.type_id, ";
		$cols .= " pt.name project_type, ";
		$cols .= " pt.highlight_style, ";
		$cols .= " p.parent_id, ";
		$cols .= " p.name, ";
		$cols .= " p.description, ";
		$cols .= " p.summary, ";
		$cols .= " p.priority, ";
		$cols .= " p.started, ";
		$cols .= " p.updated, ";
		$cols .= " p.pct_done, ";
		$cols .= " p.goals, ";
		$cols .= " p.lessons_learned, ";
		$cols .= " p.show_always, ";
		$cols .= " p.location_id, ";
		$cols .= " l.sort_key location_name, ";
		$cols .= " p.purpose, ";
		$cols .= " p.hours_estimated, ";
		$cols .= " p.hours_actual, ";
		$cols .= " p.budget_estimated, ";
		$cols .= " p.budget_notes, ";
		$cols .= " p.hours_notes ";
		return $cols;
	}
//projects table fields displayed in detail
public function listProjectsByStatus($projectStatus, $resultPage, $rowsPerPage){
$q = " SELECT  ";
$q .= $this->columns();
$q .= " FROM projects p ";
$q .= " LEFT OUTER JOIN locations l ";
$q .= " ON p.location_id = l.id ";
$q .= " LEFT OUTER JOIN project_types pt ";
$q .= " ON p.type_id = pt.id ";
if ($projectStatus=='CLOSED'){
	$q .= " WHERE p.pct_done = '1.00' "; 
} else {
	$q .= " WHERE p.pct_done != '1.00' "; 
}
$q .= " ORDER BY l.sort_key, p.priority, p.id ";
$q .= sqlLimitClause($resultPage, $rowsPerPage);
return $q;
}

public function listProjectsByDoneBy($activityDoneBy, $projectStatus, $resultPage, $rowsPerPage){
$q = " SELECT  ";
$q .= $this->columns();
$q .= " FROM projects p ";
$q .= " LEFT OUTER JOIN locations l ";
$q .= " ON p.location_id = l.id ";
$q .= " LEFT OUTER JOIN project_types pt ";
$q .= " ON p.type_id = pt.id ";

if ($projectStatus=='CLOSED'){
	$q .= " WHERE p.pct_done = '1.00' "; 
} else {
	
	$q .= " WHERE p.pct_done != '1.00' "; 
}
$q .= " AND p.id IN ";
$q .= " (select t.project_id from ";
$q .= " activities a JOIN tasks t ON a.task_id = t.id ";
$q .= " WHERE UPPER(a.done_by) = UPPER('".$activityDoneBy."') ) ";
$q .= " ORDER BY l.sort_key, p.priority, p.id ";
$q .= sqlLimitClause($resultPage, $rowsPerPage);
return $q;
}

public function countProjectsByDoneBy($activityDoneBy, $projectStatus){
$q = " SELECT  count(*) total_projects ";
$q .= " FROM projects p ";
if ($projectStatus=='CLOSED'){
	$q .= " WHERE p.pct_done = '1.00' "; 
} else {
	
	$q .= " WHERE p.pct_done != '1.00' "; 
}
$q .= " AND p.id IN ";
$q .= " (select t.project_id from ";
$q .= " activities a JOIN tasks t ON a.task_id = t.id ";
$q .= " WHERE UPPER(a.done_by) = UPPER('".$activityDoneBy."') ) ";
return $q;	
}

public function countProjectsByStatus($projectStatus){
$q = " SELECT  ";
$q .= " COUNT(*) total_projects ";
$q .= " FROM projects AS p ";
if ($projectStatus=='CLOSED'){
	$q .= " WHERE p.pct_done = '1.00' "; 
} else {
	$q .= " WHERE p.pct_done != '1.00' "; 
}
return $q;
}

public function listChildProjects($selectedProjectId){
$q = " SELECT  ";
$q .= $this->columns();
$q .= " FROM projects p ";
$q .= " LEFT OUTER JOIN locations l ";
$q .= " ON p.location_id = l.id ";
$q .= " LEFT OUTER JOIN project_types pt ";
$q .= " ON p.type_id = pt.id ";

$q .= " WHERE p.parent_id = ".$selectedProjectId." "; 
$q .= " ORDER BY p.sort_key, p.priority, p.id ";
return $q;
}

public function info($selectedProjectId){
$q = " SELECT  ";
$q .= $this->columns();
$q .= " FROM projects p ";
$q .= " LEFT OUTER JOIN locations l ";
$q .= " ON p.location_id = l.id ";
$q .= " LEFT OUTER JOIN project_types pt ";
$q .= " ON p.type_id = pt.id ";

$q .= " WHERE p.id = ".$selectedProjectId." "; 
return $q;
}

public function selectOptions_Projects($selectedValue,$disabled){
	$q = " SELECT ";
	$q .= " p.id as value, ";
	$q .= " p.name as caption ";
	$q .= " FROM projects p ";
	$q .= " WHERE p.pct_done < 1 ";
	if ($disabled == 'true'){
		$q .= " AND p.id = ".$selectedValue." ";	
	}
	$q .= " ORDER BY name ";
	return $q;	
}
public function selectOptions_ProjectsByTypeId($typeId){
	$q = " SELECT ";
	$q .= " p.id as value, ";
	$q .= " p.name as caption ";
	$q .= " FROM projects p ";
	$q .= " WHERE p.pct_done < 1 ";
	$q .= " AND (p.type_id > 0 AND p.type_id = ".$typeId.") ";
//	if ($disabled == 'true'){
//		$q .= " AND p.id = ".$selectedValue." ";	
//	}
	$q .= " ORDER BY name ";
	return $q;	
}


	public function copy($idSource){

			$sql = " INSERT INTO projects ";
			$sql .= " (name, ";
			$sql .= " parent_id, ";
			$sql .= " location_id, ";
			$sql .= " started, ";
			$sql .= " updated, ";
			$sql .= " description, ";
			$sql .= " summary, ";
			//$sql .= " lessons_learned, ";
			$sql .= " show_always, ";
			$sql .= " type_id, ";
			$sql .= " purpose) ";
			$sql .= " SELECT ";
			$sql .= " name, ";
			$sql .= " id, ";
			$sql .= " location_id, ";
			$sql .= " CURRENT_TIMESTAMP, ";
			$sql .= " CURRENT_TIMESTAMP, ";
			$sql .= " description, ";
			$sql .= " summary, ";
			//$sql .= " lessons_learned, ";
			$sql .= " show_always, ";
			$sql .= " type_id, ";
			$sql .= " purpose ";
			$sql .= " FROM projects p WHERE p.id = ".$idSource." ";
			
			return $sql;
			
	}

	public function copyTasks($idSource, $idCopy){
			//insert all tasks from source project to copy project 
			//substituting the copy project id		
			$sql = " INSERT INTO tasks ";
			$sql .= " (name, ";
			$sql .= " project_id, ";
			$sql .= " location_id, ";
			$sql .= " type_id, ";			
			$sql .= " task_order, ";
			$sql .= " description, ";
			$sql .= " summary, ";
			$sql .= " started, ";
			$sql .= " updated, ";
			$sql .= " hours_estimated, ";
			$sql .= " hours_actual, ";
			$sql .= " hours_notes, ";
			$sql .= " materials_auth_project, ";
			$sql .= " materials_auth_by, ";
			$sql .= " receipts_auth_project, ";
			$sql .= " receipts_auth_by) ";
			$sql .= " SELECT ";
			$sql .= " name, ";
			$sql .= " ".$idCopy.", ";
			$sql .= " location_id, ";
			$sql .= " type_id, ";			
			$sql .= " task_order, ";
			$sql .= " description, ";
			$sql .= " summary, ";
			$sql .= " CURRENT_TIMESTAMP, ";
			$sql .= " CURRENT_TIMESTAMP, ";
			$sql .= " hours_estimated, ";
			$sql .= " 0, ";
			$sql .= " hours_notes, ";
			$sql .= " 'no', ";
			$sql .= " 'n/a copied project', ";
			$sql .= " 'no', ";
			$sql .= " 'n/a copied project' ";
			$sql .= " FROM tasks t WHERE t.project_id = ".$idSource." ";

		return $sql;
	}

}
?>
